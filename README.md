by EricSanchez




- [ä¸€ã€å‰è¨€](#ä¸€å‰è¨€)
- [äºŒã€ç†è®ºåŸºç¡€](#äºŒç†è®ºåŸºç¡€)
- [ä¸‰ã€é¡¹ç›®åˆ†æ](#ä¸‰é¡¹ç›®åˆ†æ)
- [å››ã€å·¥ç¨‹æ–‡ä»¶](#å››å·¥ç¨‹æ–‡ä»¶)
- [äº”ã€åŒç›®ç›¸æœºæ ‡å®š](#äº”åŒç›®ç›¸æœºæ ‡å®š)
  - [ç›¸æœºæ ‡å®šç›®çš„](#ç›¸æœºæ ‡å®šç›®çš„)
  - [ç›¸æœºæ ‡å®šè§„èŒƒ](#ç›¸æœºæ ‡å®šè§„èŒƒ)
- [å…­ã€ç«‹ä½“æ ¡æ­£](#å…­ç«‹ä½“æ ¡æ­£)
- [ä¸ƒã€ç«‹ä½“åŒ¹é…ä¸ä¸‰ç»´ç‚¹äº‘](#ä¸ƒç«‹ä½“åŒ¹é…ä¸ä¸‰ç»´ç‚¹äº‘)
- [å…«ã€ç‰¹å¾æå–](#å…«ç‰¹å¾æå–)
- [ä¹ã€å·ç§¯é™ç»´æ“ä½œ](#ä¹å·ç§¯é™ç»´æ“ä½œ)
- [åã€å¯è§†åŒ–](#åå¯è§†åŒ–)
- [åä¸€ã€é¢˜å¤–ï¼šä¸‰è§’æµ‹é‡](#åä¸€é¢˜å¤–ä¸‰è§’æµ‹é‡)
- [åäºŒã€æ€»ç»“](#åäºŒæ€»ç»“)




## ä¸€ã€å‰è¨€

è¯»ç ”ä»¥æ¥ï¼Œä¸€ç›´åœ¨å¿™ä¸œå¿™è¥¿ï¼Œå¾ˆä¹…æ²¡æœ‰åšè¿‡ä¸€ä¸ªæ¯”è¾ƒå®Œæ•´çš„é¡¹ç›®äº†ï¼Œå€Ÿç€ã€Šæœºå™¨è§†è§‰ã€‹è¿™é—¨è¯¾çš„ç»“è¯¾ä½œä¸šï¼Œåˆšå¥½å®éªŒå®¤é‡Œæœ‰ä¸€ä¸ªå°ä»»åŠ¡éœ€è¦ç”¨åˆ°ï¼ŒæŠŠåŒç›®ç«‹ä½“è§†è§‰çš„æµç¨‹èµ°äº†ä¸€éï¼Œç‰¹æ­¤è®°å½•ä¸‹æ¥ã€‚

é¡¹ç›®ç”¨åˆ°çš„ç›¸å…³æŠ€æœ¯éƒ½æ˜¯éå¸¸åŸºç¡€çš„ï¼Œå¹¶ä¸”ç”±äºæ˜¯å…·ä½“çš„åº”ç”¨å®æˆ˜ï¼Œæºç ä¸ä¼šæœ‰å¾ˆå¼ºçš„é€šç”¨æ€§ï¼Œä½†æ˜¯æµç¨‹æ˜¯å¤§å·®ä¸å·®çš„ã€‚


## äºŒã€ç†è®ºåŸºç¡€

**==å¦‚æœçœŸçš„å¸Œæœ›åšå¥½ä¸€ä»¶äº‹ï¼Œå­¦ä¹ å……è¶³çš„ç†è®ºåŸºç¡€æ˜¯éå¸¸å¿…è¦çš„ #EE3F4D==**ï¼Œå…³äºä¸‰ç»´é‡å»ºçš„ç›¸å…³ç†è®ºçŸ¥è¯†ï¼ŒçŸ¥ä¹çš„ä¸€ä½åšä¸»è®²çš„å·²ç»å†™å¥½äº†ä¸€ç³»åˆ—çš„åšå®¢ï¼Œæ€è·¯éå¸¸æ¸…æ™°ï¼Œå¯ä»¥å­¦ä¹ å‚è€ƒï¼š
[ä¸‰ç»´é‡å»º1â€”â€”ç›¸æœºå‡ ä½•æ¨¡å‹å’ŒæŠ•å½±çŸ©é˜µ](https://zhuanlan.zhihu.com/p/458000359)
[ä¸‰ç»´é‡å»º2â€”â€”ç›¸æœºå‡ ä½•å‚æ•°æ ‡å®š](https://zhuanlan.zhihu.com/p/462757273)
[ä¸‰ç»´é‡å»º3â€”â€”ä¸¤è§†å›¾å‡ ä½•](https://zhuanlan.zhihu.com/p/463289634)
[ä¸‰ç»´é‡å»º4â€”â€”ç«‹ä½“æ ¡æ­£(Recitification)](https://zhuanlan.zhihu.com/p/466365225)


## ä¸‰ã€é¡¹ç›®åˆ†æ

å½“ä½ æ¥æ‰‹äº†ä¸€ä¸ªåŒç›®è§†è§‰é¡¹ç›®æ—¶ï¼Œæœ€å…ˆè¦åšçš„æ˜¯å¯¹ä»»åŠ¡è¿›è¡Œå…·ä½“çš„åˆ†æï¼Œæ¯”å¦‚ï¼š

* **æµ‹é‡çš„å¯¹è±¡æ˜¯è°ï¼Ÿæœ‰å“ªäº›ç‰¹å¾ï¼Ÿ**
* **å·¥ä½œè·ç¦»å¤„åœ¨ä»€ä¹ˆèŒƒå›´ï¼Ÿ**
* **å·¥ä½œç¯å¢ƒæ˜¯æ€æ ·çš„ï¼Ÿ**
* **æœ‰æ— å®æ—¶æ€§çš„è¦æ±‚ï¼Ÿ**
* ......


**è¿™äº›åˆ†æä¼šç›´æ¥å†³å®šç›¸æœºè¯¥å¦‚ä½•é€‰å‹ã€è¦åšåˆ°ä»€ä¹ˆç¨‹åº¦ã€ç”¨åˆ°å“ªäº›æ–¹æ³•ä»¥åŠæ•´ä½“çš„éš¾æ˜“åº¦**ã€‚


ä¸€å¼€å§‹æ—¶çš„ä»»åŠ¡æ˜¯æµ‹é‡å¦‚ä¸‹å›¾æ‰€ç¤ºçš„å¯¼ä¸(==ç›´å¾„0.4mm #EE3F4D==)åœ¨ä¸‰ç»´ç©ºé—´ä¸­çš„åæ ‡ï¼Œ==å·¥ä½œè·ç¦»çº¦ä¸º20~30cm #EE3F4D==ï¼š

![å¯¼ä¸(çº¦0.4mm)](./images/1685446350804.png)

ç»è¿‡æˆ‘çš„è®¡ç®—ï¼Œä¸ºäº†èƒ½å¤Ÿè®©å¦‚æ­¤ç»†çš„å¯¼ä¸åœ¨å›¾åƒä¸­èƒ½å¤Ÿå¤šå æ®å‡ ä¸ªåƒç´ ï¼Œæˆ‘é€‰æ‹©äº†ä¸¤ä¸ª8000x6000çš„å·¥ä¸šç›¸æœº(ä¸§å¿ƒç—…ç‹‚ï¼Œå®é™…ä¸Šæœ€åé€šè¿‡é™é‡‡æ ·åªç”¨äº†800x600)ã€‚

![](./images/1685446873113.jpg)

![ç›¸æœºå‚æ•°](./images/1685446886444.jpg)

ä½†æ˜¯å¯¼ä¸çš„æ£€æµ‹æç½®äº†ï¼Œæœ€åå˜æˆäº†æ£€æµ‹å¯¼ç®¡çš„ä¸‰ç»´ä½ç½®ï¼Œå¯¼ç®¡çš„ç›´å¾„çº¦ä¸º==3mm #EE3F4D==ï¼Œå› æ­¤ä¹Ÿå°±ä¸å†éœ€è¦é‚£ä¹ˆé«˜çš„åˆ†è¾¨ç‡ï¼Œ==800x600å®Œå…¨å¤Ÿç”¨ #EE3F4D==ã€‚

![3mmç›´å¾„çš„å¯¼ç®¡](./images/1685450936307.jpg)

==æ³¨æ„ #EE3F4D==ï¼šåˆ†è¾¨ç‡å¢å¤§çš„åŒæ—¶å¸¦æ¥çš„ä¸ä»…ä»…æ˜¯å¸§ç‡çš„ä¸‹é™ï¼Œé€šå¸¸è®¡ç®—è§†å·®å›¾çš„ç®—æ³•é€‚é…çš„å›¾åƒå°ºå¯¸æ¯”è¾ƒä½ï¼Œå¦‚æœä½ ä½¿ç”¨è¶…é«˜åˆ†è¾¨ç‡çš„å›¾åƒï¼Œä½ çš„è§†å·®å›¾çš„æ•ˆæœæœ‰å¯èƒ½ä¼šå¾ˆå·®ã€‚

æœ€ç»ˆæ­å»ºå¥½çš„å·¥ä½œç¯å¢ƒå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![æœ€ç»ˆçš„åœºæ™¯å¸ƒç½®](./images/1685446122247.jpg)

è¦æ£€æµ‹çš„å¯¼ç®¡å¤„äºç›¸æœºçš„æ­£ä¸‹æ–¹ï¼Œå¹¶ä¸”å¯¼ç®¡çš„è½´å‘æ–¹å‘æ˜¯==æ²¿ç€ç›¸æœºçš„yè½´å¸ƒç½® #EE3F4D==ï¼Œä¸ºä»€ä¹ˆè¿™æ ·åšå‘¢ï¼Ÿ

å®é™…ä¸Š**åœ¨é¡¹ç›®åæœŸæˆ‘ä»¬æ‰æ„è¯†åˆ°ï¼Œåº”è¯¥å°†ç›¸æœºçš„yè½´å’Œå¯¼ç®¡çš„æ–¹å‘å¯¹é½ï¼Œè¿™ä¸€æ­¥æ˜¯æå…¶å…³é”®çš„**ã€‚å› ä¸ºåœ¨è®¡ç®—è§†å·®å›¾(ç«‹ä½“åŒ¹é…)ä¹‹å‰ï¼Œè¦è¿›è¡Œç«‹ä½“çŸ«æ­£ï¼Œè¿™ä¸€æ­¥çš„ç›®çš„æ˜¯å°†ä¸¤å¹…å›¾åƒçš„æçº¿å¯¹é½ï¼Œä½¿å¾—åŒä¸€å¯¹ç‰¹å¾ç‚¹çš„yç›¸åŒï¼Œè¿™æ ·æˆ‘ä»¬è®¡ç®—è§†å·®åŒ¹é…ç‰¹å¾ç‚¹æ—¶åªéœ€è¦æ²¿ç€xè½´è¿›è¡Œçª—å£æ»‘åŠ¨å³å¯ã€‚

å¯ä»¥çœ‹ä¸‹å›¾ï¼Œå¯¼ç®¡æ²¿ç€ç›¸æœºyè½´å¸ƒç½®ï¼Œè¿™æ ·ä½ åœ¨æ²¿ç€xè½´è¿›è¡ŒåŒ¹é…æ—¶ï¼Œå·¦å›¾ä¸å³å›¾çš„å¯¼ç®¡æ˜¯å¾ˆå®¹æ˜“åŒ¹é…ä¸Šçš„ï¼Œç„¶è€Œï¼Œå¦‚æœå¯¼ç®¡æ²¿ç€xè½´å¸ƒç½®(å³å°†å¯¼ç®¡æ¨ªè¿‡æ¥)ï¼Œåœ¨ç®—æ³•è¿›è¡Œxè½´æ»‘åŠ¨æ—¶ï¼Œç”±äºå¯¼ç®¡æ°´å¹³å¸ƒç½®ï¼Œè€Œå¯¼ç®¡ä¸Šå„ä¸ªç‚¹çš„ç›¸ä¼¼åº¦å¾ˆé«˜ï¼Œå› æ­¤è¯¯åŒ¹é…çš„å¯èƒ½æ€§éå¸¸å¤§ï¼Œè®¡ç®—å‡ºæ¥çš„è§†å·®å›¾éå¸¸ç³Ÿç³•ï¼Œè¿™æ˜¯è¿™æ¬¡é¡¹ç›®è¸©è¿‡çš„æœ€å¤§çš„å‘ã€‚


![ç›¸æœºè§†è§’(å·¦)](./images/1685448186403.png)


## å››ã€å·¥ç¨‹æ–‡ä»¶


å®Œæ•´çš„é¡¹ç›®æ–‡ä»¶å·²ç»ä¸Šä¼ è‡³GitHubä¸Šï¼š[Ericçš„å·¥ç¨‹æ–‡ä»¶](https://github.com/EricSanchezok/StereoVision.git)

![æ–‡ä»¶ç»“æ„](./images/1685451661284.png)
``` markdown
main.pyï¼šä¸»å‡½æ•°

Params.pyï¼šåŒ…å«æ ‡å®šå¥½çš„ç›¸æœºå†…å‚å¤–å‚ã€SGBMç®—æ³•å‚æ•°ä»¥åŠä¸€äº›å…¨å±€å‚æ•°ç­‰ã€‚

Feature_Extraction.pyï¼šåŒ…å«å¯¹å¯¼ç®¡è¿›è¡Œé¢œè‰²è¯†åˆ«ã€éª¨æ¶æå–ç­‰æ“ä½œçš„å‡½æ•°ã€‚

Stereo_Vision.pyï¼šåŒ…å«å¯¹å·¦å³ç›¸æœºçš„å›¾åƒè®¡ç®—è§†å·®å›¾ã€ä¸‰ç»´ç‚¹äº‘è®¡ç®—ç­‰å‡½æ•°ã€‚

Visualation.pyï¼šåŒ…å«å¯¹ç»“æœè¿›è¡Œå¯è§†åŒ–çš„å‡½æ•°ã€‚

Convolution.pyï¼šå¯¹éª¨æ¶å›¾åƒè¿›è¡Œå·ç§¯æ“ä½œï¼Œæ•°æ®é™ç»´ã€‚

```


## äº”ã€åŒç›®ç›¸æœºæ ‡å®š

### ç›¸æœºæ ‡å®šç›®çš„

å¾ˆå¤šåšä¸»éƒ½ä¼šå…ˆè¿›è¡Œå•ç›®æ ‡å®šå¾—åˆ°å†…å‚ï¼Œå†è¿›è¡ŒåŒç›®æ ‡å®šå¾—åˆ°å¤–å‚ï¼Œå‡ ä¹æ²¡æœ‰äººè§£é‡Šè¿‡ä¸ºä»€ä¹ˆè¿™æ ·åšã€‚å®é™…ä¸Šåœ¨matlabä¸­æ— è®ºæ˜¯å•ç›®æ ‡å®šè¿˜æ˜¯åŒç›®æ ‡å®šï¼Œéƒ½å¯ä»¥è·å¾—ç›¸æœºçš„å†…å‚ã€‚æˆ‘ä¹Ÿæ²¡æœ‰åšè¿‡æµ‹è¯•ï¼Œéš¾é“æ˜¯å•ç›®æ ‡å®šçš„å†…å‚æ›´åŠ ç²¾ç¡®ï¼Ÿ

å› æ­¤==æœ¬é¡¹ç›®è™½ç„¶åŒæ—¶è¿›è¡Œäº†å•ç›®æ ‡å®šå’ŒåŒç›®æ ‡å®šï¼Œä½†åœ¨æœ€ååº”ç”¨æ—¶åªä½¿ç”¨äº†åŒç›®æ ‡å®šçš„ç»“æœ #12AA9C==ï¼Œè€ŒåŒç›®æ ‡å®šçš„ç›®çš„å°±æ˜¯ï¼š

1. è·å¾—ç›¸æœºå†…å‚å’Œç•¸å˜ï¼šKã€D
2. è·å¾—ä¸¤ç›¸æœºé—´çš„æ—‹è½¬å’Œå¹³ç§»çŸ©é˜µï¼šRã€T


### ç›¸æœºæ ‡å®šè§„èŒƒ

ç½‘ä¸Šæœ‰å¾ˆå¤šå¸–å­è¯¦ç»†åœ°ä»‹ç»äº†ç›¸æœºæ ‡å®šè¿‡ç¨‹ä¸­è¯¥æ³¨æ„å“ªäº›è§„èŒƒäº‹é¡¹ï¼Œæ¯”å¦‚ï¼š[ç‚¹å‡»è¿™é‡Œ](https://mp.weixin.qq.com/s/HnNXEA_tRfna5BuZ3dvIAA)

åœ¨æˆ‘çš„å®è·µè¿‡ç¨‹ä¸­ï¼Œæˆ‘è®¤ä¸ºæœ‰ä»¥ä¸‹å‡ ç‚¹æ˜¯éå¸¸å…³é”®çš„ï¼š
1. ==æœ€å¥½ä½¿ç”¨ä¸“ä¸šçš„æ ‡å®šæ¿(æµ®æ³•ç»ç’ƒæˆ–è€…é“æ¿) #41AE3C==ï¼šåœ¨é¡¹ç›®è¿›è¡Œä¸­æˆ‘åšè¿‡å¤šæ¬¡çš„æ ‡å®šï¼Œåœ¨ä¸€å¼€å§‹æˆ‘ç”¨çš„æ˜¯A4çº¸æ‰“å°çš„æ£‹ç›˜æ ¼ï¼Œè¿™ç§æ‰“å°çš„æ ‡å®šæ¿å¯¹äºå†…å‚ä¸­çš„fx,fy,cx,cyçš„ç²¾åº¦æ˜¯è¶³å¤Ÿçš„ï¼Œä½†æ˜¯ç”±äºA4çº¸å¾ˆè½¯ï¼Œå¦‚æœæ‘†æ”¾çš„ä¸æ˜¯éå¸¸å¹³å¦ï¼Œå¯¹äºç•¸å˜å‚æ•°è¿˜æ˜¯æœ‰è¾ƒå¤§çš„å½±å“çš„ã€‚

![ä½¿ç”¨A4çº¸è¿›è¡Œå•ç›®æ ‡å®š](./images/1685450076281.png)

2. ==æ‹æ‘„æ ‡å®šå›¾ç‰‡æ—¶å¯ä»¥è°ƒæ•´åƒè·ï¼Œä½†æ˜¯ä¸èƒ½è°ƒæ•´ç‰©è· #12AA9C==ï¼šå¦‚æœä½ çš„ç›¸æœºå¯ä»¥è‡ªåŠ¨å¯¹ç„¦ï¼Œé‚£ä¹ˆåœ¨æ‹æ‘„å›¾ç‰‡æ˜¯ä¸è¦æ‹…å¿ƒç›¸æœºçš„è‡ªåŠ¨å¯¹ç„¦é—®é¢˜ï¼Œè€Œå¦‚æœä½ çš„ç›¸æœºæœ‰é•œå¤´ï¼Œåœ¨æ‹æ‘„å›¾åƒæ—¶å¦‚æœå‡ºç°ç¦»ç„¦ï¼Œæ˜¯ä¸å…è®¸è°ƒæ•´é•œå¤´æ¥è·å¾—æ¸…æ™°çš„å›¾åƒçš„ï¼Œåªèƒ½é€šè¿‡è°ƒæ•´æ ‡å®šæ¿çš„è·ç¦»å’Œåƒè·è¿›è¡Œæ¸…æ™°å¯¹ç„¦ã€‚
3. æ ‡å®šæ—¶çš„å…‰ç…§å°½å¯èƒ½çš„å‡åŒ€ï¼Œä¸èƒ½è¿‡æ›æˆ–è€…æ¬ æ›ã€‚
4. æ ‡å®šçš„å›¾ç‰‡æ•°é‡åœ¨15~25å¼ å·¦å³ï¼Œä¸èƒ½å¤ªå°‘ï¼Œä¹Ÿæ²¡å¿…è¦å¤ªå¤šã€‚
5. æ ‡å®šæ¿åœ¨å›¾åƒä¸­çš„å æ¯”åˆšåˆšå¥½å°±å¯ä»¥ï¼Œä¸éœ€è¦å¤ªå¤§ä¹Ÿä¸éœ€è¦å¤ªå°ï¼Œæ„Ÿè§‰è¿™ä¸ªå½±å“å¹¶ä¸æ˜¯å¾ˆå¤§ã€‚
   
æ ‡å®šè¿‡ç¨‹æ²¡æœ‰ä»€ä¹ˆå¯è®²çš„ï¼Œä½¿ç”¨matlabçš„stereo cameraå·¥å…·åŒ…è¿›è¡Œæ ‡å®šå³å¯

![åŒç›®æ ‡å®šç»“æœ](./images/1685450992884.png)
å°†æ ‡å®šå¥½çš„ç»“æœå†™å…¥Params.pyä¸­

``` python
# ç›¸æœºå†…å‚çŸ©é˜µ
K1 = np.array([[603.203230962510, 0, 0],
               [0, 603.282035569803, 0],
               [400.442038630029, 301.405795942410, 1]], dtype=float).T

D1 = np.array([0.0846, -0.1510, 0, 0, 0], dtype=float)

K2 = np.array([[605.360594316701, 0, 0],
               [0, 604.975943329530, 0],
               [400.089763847830, 299.044031919448, 1]], dtype=float).T

D2 = np.array([0.0886, -0.1568, 0, 0, 0], dtype=float)

R = np.array([[0.999034572196626, 0.0257176721743424, -0.0356163571107109],
              [-0.0258012805637891, 0.999665305337157, -0.00188976888444957],
              [0.0355558360494205, 0.00280689207150011, 0.999363749532534]], dtype=float).T

T = np.array([[-77.7771596068266], [-1.01312800155798], [2.62572217808557]], dtype=float)

F = np.array([[-8.97965080103296e-08, -7.17241155026077e-06, 0.000498161266153330],
              [-5.33652440999904e-07, -1.32009826881906e-06, 0.129244355632227],
              [-0.00153924655477953, -0.125656116896911, 0.253033715598527]], dtype=float)

E = np.array([[-0.0327896857626352, -2.61938744612640, -1.02887295018107],
              [-0.194742286493101, -0.481797741783444, 77.8197334860518],
              [-1.04641211072644, -77.7754173526746, -0.449957959277595]], dtype=float)

RNew = cv2.Rodrigues(R)[0]  # æ—‹è½¬çŸ©é˜µ
size = (800, 600)  # å›¾åƒå°ºå¯¸

# ç«‹ä½“æ ¡æ­£
R1, R2, P1, P2, Q, validPixROI1, validPixROI2 = cv2.stereoRectify(K1, D1, K2, D2, size, R, T, alpha=0)

# è®¡ç®—ç•¸å˜æ ¡æ­£çš„æ˜ å°„å…³ç³»
mapLx, mapLy = cv2.initUndistortRectifyMap(K1, D1, R1, P1, size, cv2.CV_32FC1)
mapRx, mapRy = cv2.initUndistortRectifyMap(K2, D2, R2, P2, size, cv2.CV_32FC1)
```

å¯ä»¥çœ‹åˆ°**åœ¨æœ€åå‡ è¡Œä¸­æˆ‘ä»¬é¢„å…ˆè®¡ç®—å¥½äº†è¦ä½¿ç”¨çš„å‚æ•°ï¼ŒmapLx, mapLyç­‰æ˜¯è¿›è¡Œç«‹ä½“çŸ«æ­£è¦ç”¨åˆ°çš„å‚æ•°ï¼Œé‡æŠ•å½±çŸ©é˜µQæ˜¯ä»è§†å·®å›¾ä¸­è®¡ç®—ä¸‰ç»´ç‚¹äº‘æ—¶ç”¨åˆ°çš„å‚æ•°**ã€‚



## å…­ã€ç«‹ä½“æ ¡æ­£

ç«‹ä½“æ ¡æ­£æ˜¯ä¸ºäº†å°†å·¦å³ä¸¤å¹…å›¾åƒè¿›è¡Œå¯¹é½ï¼Œè®©==åŒä¸€ç‰¹å¾ç‚¹å°½å¯èƒ½åªæœ‰xè½´ä¸Šçš„å·®ï¼Œè¿™æ ·æ‰èƒ½åˆ©ç”¨å¯¹æå‡ ä½•ä¸­çš„åŸç†å¾—åˆ°æ·±åº¦æ•°æ® #EE3F4D==ã€‚

![ç«‹ä½“æ ¡æ­£åçš„ç»“æœ](./images/1685452566499.png)

ç»è¿‡==Params.py==ä¸­çš„**mapLx**, **mapLy**ç­‰å‚æ•°åªéœ€ä¸¤è¡Œä»£ç å³å¯å®Œæˆç«‹ä½“æ ¡æ­£

``` python
imgL_rectified = cv2.remap(frameLeft, P.mapLx, P.mapLy, cv2.INTER_LINEAR)  # å·¦å›¾åƒæ ¡æ­£
imgR_rectified = cv2.remap(frameRight, P.mapRx, P.mapRy, cv2.INTER_LINEAR)  # å³å›¾åƒæ ¡æ­£
```


å®é™…ä¸ŠçŸ«æ­£å‰åçš„å›¾åƒå˜åŒ–å¹¶ä¸å¤§ï¼Œæ˜¯å› ä¸ºæœ¬èº«ç›¸æœºçš„æ‘†æ”¾æ‘†çš„å°±æ¯”è¾ƒå¥½ã€‚ä½†æ˜¯å¦‚æœä½ è§‚å¯Ÿå›¾åƒçš„ä¸€äº›è¾¹ç¼˜ä¿¡æ¯ï¼Œæ¯”å¦‚æœ€ä¸‹é¢çš„ä¸€æ¡çº¿åå³çš„ä½ç½®æœ‰ä¸€é¢—èºä¸ï¼Œæ ¡æ­£å‰å¹¶æ²¡æœ‰åœ¨ä¸€æ¡çº¿ä¸Šï¼Œç„¶è€Œæ ¡æ­£åå°±å¤„äºäº†ä¸€æ¡çº¿ä¸Šäº†ã€‚

 ![æ ¡æ­£å‰(ä¸Š) æ ¡æ­£å(ä¸‹)](./images/1685453015818.png)
 
 çœŸæ­£è¦ç»˜åˆ¶æçº¿éœ€è¦è´¹ç‚¹åŠ›ï¼Œæˆ‘ä»¬è¿™é‡Œç›´æ¥å°±æ°´å¹³çš„ç»˜åˆ¶ç›´çº¿ï¼Œè§‚å¯Ÿä¸€ä¸‹æ˜¯å¦åœ¨åŒä¸€æ¡æ°´å¹³çº¿ä¸Šå°±å¯ä»¥äº†ï¼Œå½“åšå®Œç«‹ä½“æ ¡æ­£åï¼Œæ¥ä¸‹æ¥å°±æ˜¯è®¡ç®—è§†å·®å›¾äº†ã€‚
 
 
 ## ä¸ƒã€ç«‹ä½“åŒ¹é…ä¸ä¸‰ç»´ç‚¹äº‘
 
 ç«‹ä½“åŒ¹é…åˆ™æ˜¯åœ¨å·¦å›¾(å¤§éƒ¨åˆ†éƒ½æ˜¯ä»¥å·¦å›¾ä¸ºä¸»)ä¸­é€‰æ‹©ä¸€ä¸ªç‚¹ï¼Œæ‰¾åˆ°ä¸å…¶å¯¹åº”çš„åœ¨å³å›¾ä¸­çš„ç‰¹å¾ç‚¹(åŒä¸€æ°´å¹³çº¿ä¸Š)ï¼Œæœ€åå¾—åˆ°è§†å·®:`!$ \ disparity = \ x_i - x_j\, $`
 
 æœ‰å¾ˆå¤šç§ç«‹ä½“åŒ¹é…ç®—æ³•ï¼Œæœ¬é¡¹ç›®æœ€ç»ˆä½¿ç”¨äº†SGBMç®—æ³•ï¼Œåœ¨==Stereo_Vision.py==æ–‡ä»¶ä¸­ä»£ç å¦‚ä¸‹:
 

``` python
import cv2
import Params as P
import numpy as np

def get_point_cloud(disparity, Q):
    """
    æ ¹æ®è§†å·®å›¾å’ŒæŠ•å½±çŸ©é˜µè®¡ç®—æ·±åº¦å›¾

    Args:
        disparity: è§†å·®å›¾
        Q: æŠ•å½±çŸ©é˜µ

    Returns:
        Points3D: ä¸‰ç»´ç‚¹äº‘
    """

    Points3D = cv2.reprojectImageTo3D(disparity, Q, handleMissingValues=True)  # æ ¹æ®è§†å·®å›¾å’ŒæŠ•å½±çŸ©é˜µè®¡ç®—ä¸‰ç»´ç‚¹äº‘

    return Points3D


def imgsTodisparity(frameLeft, frameRight, SGBM_parameters: P.StereoParamsInit, debug=False):
    """
    å°†å·¦å³å›¾åƒè½¬æ¢ä¸ºè§†å·®å›¾å’Œä¸‰ç»´ç‚¹äº‘

    Args:
        frameLeft: å·¦å›¾åƒå¸§
        frameRight: å³å›¾åƒå¸§
        SGBM_parameters: ç«‹ä½“åŒ¹é…ç®—æ³•å‚æ•°
        debug: æ˜¯å¦å¯ç”¨è°ƒè¯•æ¨¡å¼

    Returns:
        disp: è§†å·®å›¾
        ThreeD: ä¸‰ç»´ç‚¹äº‘
    """

    imgL_rectified = cv2.remap(frameLeft, P.mapLx, P.mapLy, cv2.INTER_LINEAR)  # å·¦å›¾åƒæ ¡æ­£
    imgR_rectified = cv2.remap(frameRight, P.mapRx, P.mapRy, cv2.INTER_LINEAR)  # å³å›¾åƒæ ¡æ­£

    imgL_gray = cv2.cvtColor(imgL_rectified, cv2.COLOR_BGR2GRAY)  # è½¬æ¢ä¸ºç°åº¦å›¾åƒ
    imgR_gray = cv2.cvtColor(imgR_rectified, cv2.COLOR_BGR2GRAY)  # è½¬æ¢ä¸ºç°åº¦å›¾åƒ

    parameters = SGBM_parameters.getParams()  # è·å–ç«‹ä½“åŒ¹é…ç®—æ³•å‚æ•°
    left_matcher = cv2.StereoSGBM_create(**parameters)  # åˆ›å»ºç«‹ä½“åŒ¹é…å¯¹è±¡

    disp = left_matcher.compute(imgL_gray, imgR_gray).astype(np.float32) / 16.0  # è®¡ç®—è§†å·®å›¾

    ThreeD = get_point_cloud(disp, P.Q)  # æ ¹æ®è§†å·®å›¾å’ŒæŠ•å½±çŸ©é˜µè®¡ç®—ä¸‰ç»´ç‚¹äº‘

    if debug:
        cv2.namedWindow('dispVisualized', cv2.WINDOW_AUTOSIZE)
        cv2.resizeWindow('dispVisualized', 800, 600)

        dispVisualized = cv2.normalize(disp, disp, alpha=0, beta=255, norm_type=cv2.NORM_MINMAX, dtype=cv2.CV_8U)
        cv2.imshow('dispVisualized', dispVisualized)

    return disp, ThreeD

```


å®é™…ä¸Šåªç”¨ä¸€ä¸¤è¡Œä»£ç å°±å¾—åˆ°äº†è§†å·®å›¾ï¼Œç„¶è€Œéš¾ç‚¹æ˜¯è°ƒSGBMçš„å‚æ•°ï¼Œåœ¨ä¸Šè¿°ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘å®šä¹‰äº†ä¸€ä¸ªæ–°çš„ç±»**SGBM_parameters**ï¼Œå¹¶é€šè¿‡è¿™ä¸ªç±»çš„æ–¹æ³•==getParams() #EE3F4D==æ¥è·å¾—SGBMçš„å‚æ•°ï¼Œè€Œç±»çš„å®šä¹‰éƒ¨åˆ†åœ¨==Params.py==ä¸­

``` python
class StereoParamsInit:
    def __init__(self, debug=False):
        self.debug = debug
        self.window_name = "bar"

        if self.debug:
            cv2.namedWindow(self.window_name, cv2.WINDOW_AUTOSIZE)
            cv2.resizeWindow(self.window_name, 800, 600)

            # åˆ›å»ºè°ƒèŠ‚å‚æ•°çš„æ»‘åŠ¨æ¡
            cv2.createTrackbar("minDisparity", self.window_name, 0, 100,
                               lambda x: cv2.setTrackbarPos("minDisparity", self.window_name, max(x, 0)))
            cv2.createTrackbar("num", self.window_name, 1, 20,
                               lambda x: cv2.setTrackbarPos("num", self.window_name, max(x, 1)))
            cv2.createTrackbar("blockSize", self.window_name, 5, 50,
                               lambda x: cv2.setTrackbarPos("blockSize", self.window_name,
                                                            max(x + 1 if x % 2 == 0 else x, 5)))
            cv2.createTrackbar("window_size", self.window_name, 1, 20,
                               lambda x: cv2.setTrackbarPos("window_size", self.window_name,
                                                            max(x + 1 if x % 2 == 0 else x, 1)))
            cv2.createTrackbar("disp12MaxDiff", self.window_name, 1, 100,
                               lambda x: cv2.setTrackbarPos("disp12MaxDiff", self.window_name, max(x, 1)))
            cv2.createTrackbar("uniquenessRatio", self.window_name, 1, 10,
                               lambda x: cv2.setTrackbarPos("uniquenessRatio", self.window_name, max(x, 1)))
            cv2.createTrackbar("speckleWindowSize", self.window_name, 1, 200,
                               lambda x: cv2.setTrackbarPos("speckleWindowSize", self.window_name, max(x, 1)))
            cv2.createTrackbar("speckleRange", self.window_name, 1, 200,
                               lambda x: cv2.setTrackbarPos("speckleRange", self.window_name, max(x, 1)))
            cv2.createTrackbar("preFilterCap", self.window_name, 1, 200,
                               lambda x: cv2.setTrackbarPos("preFilterCap", self.window_name, max(x, 1)))

    def getParams(self):
        """
        è·å–ç«‹ä½“åŒ¹é…ç®—æ³•çš„å‚æ•°
        """
        SGBM_parameters = {
            'minDisparity': cv2.getTrackbarPos("minDisparity", self.window_name) if self.debug else 50,
            'numDisparities': 16 * (cv2.getTrackbarPos("num", self.window_name) if self.debug else 16),
            'blockSize': cv2.getTrackbarPos("blockSize", self.window_name) if self.debug else 5,

            'P1': 8 * 3 * (cv2.getTrackbarPos("window_size", self.window_name) if self.debug else 3),
            'P2': 32 * 3 * (cv2.getTrackbarPos("window_size", self.window_name) if self.debug else 3),

            'disp12MaxDiff': cv2.getTrackbarPos("disp12MaxDiff", self.window_name) if self.debug else 50,
            'uniquenessRatio': cv2.getTrackbarPos("uniquenessRatio", self.window_name) if self.debug else 1,
            'speckleWindowSize': cv2.getTrackbarPos("speckleWindowSize", self.window_name) if self.debug else 400,
            'speckleRange': cv2.getTrackbarPos("speckleRange", self.window_name) if self.debug else 400,
            'preFilterCap': cv2.getTrackbarPos("preFilterCap", self.window_name) if self.debug else 200,
            'mode': cv2.STEREO_SGBM_MODE_SGBM_3WAY
        }

        return SGBM_parameters

```

ä¸ºä»€ä¹ˆè¿™ä¹ˆé•¿ï¼Œæ˜¯å› ä¸ºåœ¨æˆ‘åˆ›å»ºäº†å¾ˆå¤šçš„**trackbar**è¿›è¡Œæ‰‹åŠ¨è°ƒå‚æµ‹è¯•ï¼Œå¹¶ä¸”ç”¨**debug**è¿™ä¸ªå˜é‡æ§åˆ¶æ˜¯ä½¿ç”¨å›ºå®šçš„å‚æ•°ï¼Œè¿˜æ˜¯**trackbar**ä¸­çš„å‚æ•°ã€‚æˆ‘å¼ºçƒˆå»ºè®®å¦‚æœå¯¹è‡ªå·±çš„è°ƒå‚ä¸ä¿¡å¿ƒçš„è¯ï¼Œé‡‡ç”¨è¿™ç§æ–¹æ³•ä¸€ä¸ªä¸€ä¸ªå°è¯•ï¼Œä½ ä¼šå¯¹æ¯ä¸€ç§å‚æ•°æœ‰ç€æ›´æ·±åˆ»çš„ç†è§£ã€‚

![æœªè°ƒå‚çš„è§†å·®å›¾](./images/1685454272716.png)


![è°ƒå‚åçš„è§†å·®å›¾](./images/1685454298468.png)

å¯ä»¥çœ‹åˆ°è°ƒå‚åçš„è§†å·®å›¾ä¸­èƒŒæ™¯ä»ç„¶åä»½å˜ˆæ‚ï¼Œè¿™æ˜¯å› ä¸ºèƒŒæ™¯æœ¬èº«çš„çº¹ç†å°±æ¯”è¾ƒæ¨¡ç³Šï¼ŒåŒ¹é…å™¨å¾ˆéš¾åŒ¹é…ï¼Œä½†æ˜¯ç”±äºæˆ‘ä»¬åªéœ€è¦å¯¼ç®¡çš„ä¸‰ç»´ä¿¡æ¯å°±å¯ä»¥äº†ï¼Œå¯¼ç®¡çš„è§†å·®æ˜¯å‡†ç¡®æ¸…æ™°å³å¯ã€‚


åœ¨å¾—åˆ°è§†å·®å›¾åï¼Œå°±å¯ä»¥ä½¿ç”¨==Stereo_Vision.py==ä¸­çš„å¦ä¸€ä¸ªå‡½æ•°==get_point_cloud() #EE3F4D==ä»è§†å·®å›¾ä¸­è®¡ç®—ä¸‰ç»´ç‚¹äº‘äº†

## å…«ã€ç‰¹å¾æå–

æˆ‘ä»¬æ— éœ€å¯¹ç›¸æœºæ‹åˆ°çš„æ‰€æœ‰å†…å®¹è¿›è¡Œé‡å»ºï¼Œå› æ­¤æˆ‘ä»¬è¦å¯¹å¯¼ç®¡è¿›è¡Œåˆ†å‰²ï¼Œè·å¾—å¯¼ç®¡ä¸Šçš„ä¸€ç³»åˆ—ç‚¹ï¼Œæœ€åä»ä¸‰ç»´ç‚¹äº‘ä¸­é€‰æ‹©å¯¼ç®¡ä¸Šçš„ç‚¹å³å¯ã€‚

ç”±äºå·¥ä½œç¯å¢ƒã€å…‰ç…§æ¡ä»¶åŸºæœ¬æ˜¯ç¨³å®šçš„ï¼Œè€Œä¸”è¿˜æ·»åŠ äº†é»‘è‰²çš„èƒŒæ™¯è¿›è¡Œå¯¹æ¯”ï¼Œå› æ­¤å®Œå…¨å¯ä»¥ç›´æ¥å¯¹å›¾åƒè¿›è¡ŒäºŒå€¼åŒ–ï¼Œæˆ–è€…å…ˆè¿›è¡Œä¸€æ¬¡é¢œè‰²è¯†åˆ«ï¼Œå†äºŒå€¼åŒ–ã€‚

åœ¨==Params.py==ä¸­å®šä¹‰äº†å…¨å±€å˜é‡çš„ç±»:

``` python
class GlobalPara:
    def __init__(self, ROILeftP1, ROILeftP2, lower, upper) -> None:
        """
        å…¨å±€å‚æ•°ç±»ï¼Œç”¨äºå­˜å‚¨ä¸€äº›å‚æ•°

        Args:
            ROILeftP1: å·¦å›¾åƒæ„Ÿå…´è¶£åŒºåŸŸçš„å·¦ä¸Šè§’åæ ‡
            ROILeftP2: å·¦å›¾åƒæ„Ÿå…´è¶£åŒºåŸŸçš„å³ä¸‹è§’åæ ‡
            lower: HSV é¢œè‰²ç©ºé—´çš„ä¸‹ç•Œ
            upper: HSV é¢œè‰²ç©ºé—´çš„ä¸Šç•Œ
        """
        ROIxleftP1, ROIyleftP1 = int(ROILeftP1[0]), int(ROILeftP1[1])  # å·¦ä¸Šè§’åæ ‡
        ROIxleftP2, ROIyleftP2 = int(ROILeftP2[0]), int(ROILeftP2[1])  # å³ä¸‹è§’åæ ‡

        self.ROILeftP1 = [ROIxleftP1, ROIyleftP1]
        self.ROILeftP2 = [ROIxleftP2, ROIyleftP2]

        self.lower = lower  # HSV é¢œè‰²ç©ºé—´çš„ä¸‹ç•Œ
        self.upper = upper  # HSV é¢œè‰²ç©ºé—´çš„ä¸Šç•Œ
```

å…¶ä¸­åŒ…å«äº†ROIåŒºåŸŸï¼Œ ä»¥åŠé¢œè‰²è¯†åˆ«çš„ä¸Šä¸‹ç•Œã€‚åœ¨==main.py==ä¸­æˆ‘ä»¬åˆå§‹åŒ–è¿™ä¸ªç±»:

``` python
GP = P.GlobalPara(ROILeftP1=[320, 100], ROILeftP2=[620, 500],
                  lower=np.array([0, 0, 180]), upper=np.array([120, 40, 255]))
```


æ¥ç€å°±è¦ç”¨åˆ°==Feature_Extraction.py==äº†ï¼Œä¸»è¦ç”¨åˆ°è¿™ä¸ªæ–‡ä»¶ä¸­çš„ä¸¤ä¸ªå‡½æ•°ï¼š

``` python
def HSV_segmentation(RGBimage, lower, upper, mask) -> object:
    """
    å¯¹RGBå›¾åƒè¿›è¡ŒHSVé¢œè‰²ç©ºé—´åˆ†å‰²

    Args:
        RGBimage: è¾“å…¥çš„RGBå›¾åƒ
        lower: HSVçš„ä¸‹ç•Œ
        upper: HSVçš„ä¸Šç•Œ
        mask: åˆ†å‰²æ©ç 

    Returns:
        output: åˆ†å‰²ç»“æœå›¾åƒ
    """
    input = RGBimage.copy()

    # ä½¿ç”¨æ©ç è¿›è¡Œå›¾åƒä½ä¸æ“ä½œ
    input = cv2.bitwise_and(input, input, mask=mask)

    # å°†å›¾åƒè½¬æ¢ä¸ºHSVé¢œè‰²ç©ºé—´
    HSVimage = cv2.cvtColor(input, cv2.COLOR_BGR2HSV)

    # æ ¹æ®HSVä¸‹ç•Œå’Œä¸Šç•Œè¿›è¡Œåˆ†å‰²
    output = cv2.inRange(HSVimage, lower, upper)

    # å¯¹åˆ†å‰²ç»“æœè¿›è¡Œè†¨èƒ€æ“ä½œ
    kernel = np.ones((7, 7), np.uint8)
    output = cv2.dilate(output, kernel, iterations=1)

    # å¯¹åˆ†å‰²ç»“æœè¿›è¡Œè…èš€æ“ä½œ
    kernel = np.ones((3, 3), np.uint8)
    output = cv2.erode(output, kernel, iterations=2)

    return output


def Centerline_Extraction(SEGimage) -> object:
    """
    æå–ä¸­å¿ƒçº¿

    Args:
        SEGimage: åˆ†å‰²å›¾åƒ

    Returns:
        skeleton: ä¸­å¿ƒçº¿å›¾åƒ
        target: ä¸­å¿ƒçº¿ä¸Šçš„ç›®æ ‡ç‚¹åæ ‡
    """
    input = SEGimage.copy()

    finished = False
    size = np.size(input)
    skeleton = np.zeros(input.shape, np.uint8)
    initialsize = cv2.countNonZero(input)
    zeros = initialsize

    while (not finished):
        kersize = 3
        kernel = cv2.getStructuringElement(cv2.MORPH_CROSS, (kersize, kersize))

        eroded = cv2.erode(input, kernel)
        temp = cv2.dilate(eroded, kernel)
        temp = cv2.subtract(input, temp)

        skeleton = cv2.bitwise_or(skeleton, temp)
        input = eroded.copy()

        zeros = size - cv2.countNonZero(input)
        if zeros == size:
            finished = True

    # å¯¹ä¸­å¿ƒçº¿è¿›è¡Œè†¨èƒ€æ“ä½œ
    kernel = np.ones((3, 3), np.uint8)
    skeleton = cv2.dilate(skeleton, kernel, iterations=2)

    # å¯¹ä¸­å¿ƒçº¿è¿›è¡Œè…èš€æ“ä½œ
    kernel = np.ones((3, 3), np.uint8)
    skeleton = cv2.erode(skeleton, kernel, iterations=2)

    # è·å–ä¸­å¿ƒçº¿ä¸Šçš„ç›®æ ‡ç‚¹åæ ‡
    target = np.where(skeleton == 255)
    target = np.array(target).T

    return skeleton, target


```

==HSV_segmentation(RGBimage, lower, upper, mask) #EE3F4D==è´Ÿè´£é¢œè‰²è¯†åˆ«å¹¶ä¸”è¿”å›äºŒå€¼åŒ–çš„å›¾åƒï¼Œå…¶ä¸­ç”¨åˆ°äº†æ©ç maskï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å®šä¹‰çš„ROIåŒºåŸŸ

Centerline_Extraction(SEGimage)åˆ™æ˜¯å¯¹äºŒå€¼åŒ–çš„å›¾åƒè¿›è¡Œéª¨æ¶æå–ï¼Œç”¨åˆ°çš„æ–¹æ³•ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯è¿ç»­çš„è¿›è¡Œè…èš€æ“ä½œï¼Œç›´åˆ°å›¾åƒä¸­ä¸å†æœ‰åƒç´ ç‚¹ä¸ºæ­¢ï¼Œé‚£ä¹ˆä¸Šä¸€æ¬¡è…èš€çš„å›¾åƒå°±æ˜¯éª¨æ¶äº†ã€‚è¿™ä¸ªå‡½æ•°ä¼šè¿”å›ä¸¤ä¸ªå˜é‡ï¼Œskeletonåˆ™æ˜¯æå–å¥½çš„éª¨æ¶ï¼Œtargetåˆ™æ˜¯éª¨æ¶å¯¹åº”çš„äºŒç»´ç‚¹é›†ã€‚

æ¥ç€æˆ‘ä»¬è¦ç”¨åˆ°åŒä¸€ä¸ªæ–‡ä»¶ä¸­çš„==getTargetPoints(frameLeft, GP: P.GlobalPara, imgOriginal=None, debug=False) #EE3F4D==å‡½æ•°å°†è¿™äº›å‡½æ•°ç»“åˆèµ·æ¥ï¼š

``` python
def getTargetPoints(frameLeft, GP: P.GlobalPara, debug=False):
    """
    è·å–ç›®æ ‡ç‚¹é›†

    Args:
        frameLeft: å·¦æ‘„åƒå¤´å›¾åƒå¸§
        GP: å…¨å±€å‚æ•°
        debug: æ˜¯å¦å¼€å¯è°ƒè¯•æ¨¡å¼
        imgOriginal: åŸå§‹å›¾åƒï¼ˆç”¨äºè°ƒè¯•ï¼‰

    Returns:
        covP: ç›®æ ‡ç‚¹é›†
    """
    imgL_rectified = cv2.remap(frameLeft, P.mapLx, P.mapLy, cv2.INTER_LINEAR)

    maskLeft = np.zeros(imgL_rectified.shape[:2], dtype=np.uint8)
    maskLeft[GP.ROILeftP1[1]:GP.ROILeftP2[1], GP.ROILeftP1[0]:GP.ROILeftP2[0]] = 255

    SEGimage = HSV_segmentation(imgL_rectified, GP.lower, GP.upper, mask=maskLeft)

    SKEimage, TargetPoints = Centerline_Extraction(SEGimage)

    start = np.argmin(TargetPoints[:, 0])
    start = TargetPoints[start]

    covP = COV.convolution(SEGimage, start=start, size=[20, 20], step=10, max_pixels=30, debug=debug)

    if debug:
        combinedOut = np.hstack([SEGimage, SKEimage])
        cv2.namedWindow('SEG&SKEcombinedOut', cv2.WINDOW_AUTOSIZE)
        cv2.resizeWindow('SEG&SKEcombinedOut', 1600, 600)
        cv2.imshow('SEG&SKEcombinedOut', combinedOut)

    return covP
```

æˆ‘ä»¬é¦–å…ˆè¿›è¡ŒHSVé¢œè‰²è¯†åˆ«å¾—åˆ°**SEGimage**ï¼Œç„¶åå¯¹**SEGimage**è¿›è¡Œéª¨æ¶æå–å¾—åˆ°**SKEimage**ï¼Œæ¥ä¸‹æ¥çš„æ“ä½œåˆ™æ˜¯å¯¹**SKEimage**å›¾åƒè¿›è¡Œå·ç§¯(ä»£ç ä¸­ç”¨çš„æ˜¯**SEGimage**ï¼Œå…¶å®ç”¨**SKEimage**çš„è®¡ç®—é‡ä¼šå°ä¸€äº›)

![é¢œè‰²è¯†åˆ«(å·¦)éª¨æ¶æå–(å³)](./images/1685455998523.png)

æœ€åä¸€æ­¥å¯¹å›¾åƒè¿›è¡Œäº†å·ç§¯ï¼Œé‚£ä¹ˆè¿™ä¸ªå·ç§¯æ“ä½œçš„å«ä¹‰æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ

## ä¹ã€å·ç§¯é™ç»´æ“ä½œ

æŸ¥çœ‹==Convolution.py==æ–‡ä»¶

``` python
import numpy as np
import cv2
import math

class vector:
    def __init__(self, x, y):
        self.x = x
        self.y = y
    
    def __add__(self, other):
        return vector(int(self.x + other.x), int(self.y + other.y))
    
    def __sub__(self, other):
        return vector(int(self.x - other.x), int(self.y - other.y))
    
    def __mul__(self, other):
        return vector(self.x * other, self.y * other)
    
    def __str__(self):
        return "vector: x = %d, y = %d" % (self.x, self.y)
    
    def length(self):
        return int(math.sqrt(self.x**2 + self.y**2))


def convolution(image_conv, start, size, step, max_pixels, debug=False):
    """
    å·ç§¯å‡½æ•°ï¼Œç”¨äºæå–ç›®æ ‡ç‚¹é›†

    Args:
        image_conv: è¾“å…¥å›¾åƒ
        start: èµ·å§‹ç‚¹åæ ‡
        size: åŒºåŸŸå¤§å°
        step: æ­¥é•¿
        max_pixels: æœ€å¤§åƒç´ æ•°
        debug: æ˜¯å¦å¼€å¯è°ƒè¯•æ¨¡å¼
        imgOriginal: åŸå§‹å›¾åƒï¼ˆç”¨äºè°ƒè¯•ï¼‰

    Returns:
        result: ç›®æ ‡ç‚¹é›†
    """
    result = []

    startPoint = vector(start[1], start[0])
    lastOriMeanVec = startPoint

    region = image_conv[int(startPoint.y-size[0]/2):int(startPoint.y+size[0]/2), int(startPoint.x-size[1]/2):int(startPoint.x+size[1]/2)]

    if debug:
        cv2.namedWindow("region", cv2.WINDOW_NORMAL)
        cv2.resizeWindow("region", 100, 100)

    while(np.array(np.where(region != 0)).shape[1] > max_pixels):
        region_mean = np.array(np.where(region != 0))
        if region_mean.shape[1] == 0:
            break
        region_mean = region_mean.mean(axis=1).astype(int)
        region_meanVec = vector(region_mean[1], region_mean[0])
        ori_meanVec = vector(startPoint.x-size[1]/2, startPoint.y-size[0]/2) + region_meanVec
        point = [ori_meanVec.y, ori_meanVec.x]
        result.append(point)

        if debug:
            cv2.imshow("region", region)

        forwardVec = ori_meanVec - lastOriMeanVec
        lastOriMeanVec = ori_meanVec
        forwardVec = vector((forwardVec.x*step / forwardVec.length()),int(forwardVec.y*step / forwardVec.length()))

        startPoint = ori_meanVec + forwardVec

        region = image_conv[int(startPoint.y-size[0]/2):int(startPoint.y+size[0]/2), int(startPoint.x-size[1]/2):int(startPoint.x+size[1]/2)]

    return result

```


é€šä¿—çš„æ¥è®²ï¼Œå°±æ˜¯å…ˆè§„å®šä¸€ä¸ªèµ·ç‚¹startPointå’Œä¸€ä¸ªå·ç§¯æ ¸ï¼Œä»èµ·ç‚¹å¼€å§‹å·ç§¯æ“ä½œï¼Œåœ¨å·ç§¯å‰è®¡ç®—å½“å‰å·ç§¯æ ¸ä¸­çš„å›¾åƒé‡å¿ƒï¼Œç¬¬ä¸€æ¬¡å·ç§¯æ—¶å‘xè½´æ­£æ–¹å‘èµ°ä¸€æ­¥ï¼Œç„¶åæ›´æ–°é‡å¿ƒä½ç½®ï¼Œä»¥ä¸¤æ¬¡é‡å¿ƒä½ç½®è®¡ç®—å‘é‡ï¼Œä¸‹æ¬¡ç§»åŠ¨å·ç§¯æ ¸çš„æ—¶å€™å°±ä¼šæ ¹æ®è¿™ä¸ªå‘é‡è¿›è¡Œç§»åŠ¨ï¼Œè¿™æ ·å°±ç›¸å½“äºæ²¿ç€å¯¼ç®¡è¿›è¡Œäº†å·ç§¯ï¼Œå¾—åˆ°äº†ä¸€ç³»åˆ—çš„é‡å¿ƒæ‰€ç»„æˆçš„ç‚¹é›†ã€‚

ä¸ºä»€ä¹ˆè¦è¿›è¡Œè¿™ä¸€æ­¥å‘¢ï¼Ÿæˆ‘ä»¬ç»è¿‡éª¨æ¶æå–åå¾—åˆ°çš„targetç‚¹é›†å·²ç»å¯ä»¥ç”¨æ¥ä¸‰ç»´é‡å»ºäº†ï¼Œä½†æ˜¯è¯¥é›†åˆä¸­çš„ç‚¹çš„æ•°é‡å¾ˆå¤šï¼Œçº¦300ä¸ªå·¦å³ï¼Œç„¶è€Œè¡¨å¾ä¸€æ ¹å¯¼ç®¡åœ¨ç©ºé—´ä¸­çš„èµ°å‘ï¼Œåªéœ€è¦æ²¿ç€å¯¼ç®¡çš„åå‡ ä¸ªç‚¹å°±å¯ä»¥äº†ï¼Œè®¾ç½®åˆç†çš„å·ç§¯æ ¸å¤§å°ä»¥åŠåˆç†çš„æ­¥é•¿ï¼Œé€šè¿‡å·ç§¯æ“ä½œå°±å¯ä»¥å°†300å¤šä¸ªç‚¹é™åˆ°åå‡ ä¸ªç‚¹(covP)ã€‚


## åã€å¯è§†åŒ–

æ¥ç€æˆ‘ä»¬æå–ä¸‰ç»´ç‚¹äº‘ä¸­covPå¯¹åº”çš„ç‚¹é›†æ‹¿å‡ºæ¥è¿›è¡Œå¯è§†åŒ–ï¼Œç»“æœå¦‚ä¸‹:

![å®æ—¶ä¸‰ç»´é‡å»º](./images/1685456197565.gif)

## åä¸€ã€é¢˜å¤–ï¼šä¸‰è§’æµ‹é‡

å½“ä½ æ ‡å®šå®Œä¹‹åï¼Œä¸ç¡®å®šè‡ªå·±çš„å†…å‚æ˜¯å¦æ­£ç¡®ï¼Œå¯ä»¥ä½¿ç”¨æ‰‹åŠ¨æ ‡ç‚¹åŒæ—¶è¿›è¡Œä¸‰è§’æµ‹é‡æ¥éªŒè¯ï¼Œä¸‰è§’æµ‹é‡ä¸éœ€è¦è¿›è¡Œç«‹ä½“çŸ«æ­£ï¼Œç‰¹å¾ç‚¹åŒ¹é…ç­‰æ“ä½œï¼Œç”¨åˆ°çš„å‡½æ•°å¦‚ä¸‹ï¼š

``` python
def distance(x, y):
        l = 0.0
        x = np.array(x, dtype=float)
        y = np.array(y, dtype=float)
        for i in range(3):
                l += (x[i]-y[i])**2
        return math.sqrt(l) 

def uv2xyz(cor):
			# å‡½æ•°å‚æ•°ä¸ºå·¦å³ç›¸ç‰‡åŒåç‚¹çš„åƒç´ åæ ‡ï¼Œè·å–æ–¹å¼åé¢ä»‹ç»
			# lxï¼Œlyä¸ºå·¦ç›¸æœºæŸç‚¹åƒç´ åæ ‡ï¼Œrxï¼Œryä¸ºå³ç›¸æœºå¯¹åº”ç‚¹åƒç´ åæ ‡, lx = ()
        lx, ly, rx, ry = cor[0], cor[1], cor[2], cor[3]
		
        mLeft = np.hstack([np.eye(3), np.array([[0],[0],[0]], dtype=float) ])
        mLeftM = np.dot(K1, mLeft)
		
        mRight = np.hstack([R, T])
        mRightM = np.dot(K2, mRight)
		
        A = np.zeros(shape=(4, 3))
        for i in range(0, 3):
                A[0][i] = lx * mLeftM[2, i] - mLeftM[0][i]
        for i in range(0, 3):
                A[1][i] = ly * mLeftM[2][i] - mLeftM[1][i]
        for i in range(0, 3):
                A[2][i] = rx * mRightM[2][i] - mRightM[0][i]
        for i in range(0, 3):
                A[3][i] = ry * mRightM[2][i] - mRightM[1][i]
        B = np.zeros(shape=(4, 1))
        for i in range(0, 2):
                B[i][0] = mLeftM[i][3] - lx * mLeftM[2][3]
        for i in range(2, 4):
                B[i][0] = mRightM[i - 2][3] - rx * mRightM[2][3]
        XYZ = np.zeros(shape=(3, 1))
        # æ ¹æ®å¤§ä½¬çš„æ–¹æ³•ï¼Œé‡‡ç”¨æœ€å°äºŒä¹˜æ³•æ±‚å…¶ç©ºé—´åæ ‡
        cv2.solve(A, B, XYZ, cv2.DECOMP_SVD)
        print("ç©ºé—´åæ ‡/mm ", XYZ)
        return XYZ

if __name__ == "__main__":
			# right
			# Clicked at position (x=402, y=888)
			# Clicked at position (x=1168, y=849)
			# left
			# Clicked at position (x=643, y=895)
			# Clicked at position (x=1384, y=830)
        point1 = uv2xyz(np.array([643, 895, 402, 888], dtype=float)*5)
        point2 = uv2xyz(np.array([1384, 830, 1168, 849], dtype=float)*5)
        print("ä¸¤ç‚¹ä¹‹é—´è·ç¦»ä¸ºï¼š", distance(point1, point2))
```

æ³¨æ„å¥½Rå’ŒTè¯¥ç”¨åœ¨å“ªé‡Œï¼Œå› ä¸ºå¤§å¤šæ•°éƒ½æ˜¯ä»¥å·¦å›¾ä½œä¸ºåŸºå‡†ï¼Œå› æ­¤è¦å¯¹å³å›¾è¿›è¡ŒRå’ŒTçš„å˜æ¢ï¼Œå› æ­¤å·¦å›¾çš„Rå’ŒTå°±å…¨éƒ½æ˜¯æ ‡å‡†çŸ©é˜µäº†

æ¥ä¸‹æ¥é€‰æ‹©å·¦å›¾å’Œå³å›¾çš„ä¸¤å¯¹å¯¹åº”ç‚¹ï¼Œè®¡ç®—å…¶ä¸‰ç»´ç©ºé—´çš„ç‚¹point1å’Œpoint2ï¼Œå¹¶ä¸”è®¡ç®—è¿™ä¸¤ä¸ªä¸‰ç»´ç‚¹ä¹‹é—´çš„è·ç¦»ï¼Œå†æ‰‹åŠ¨æµ‹é‡ï¼Œçœ‹çœ‹æ˜¯å¦å‡†ç¡®ã€‚

![æµ‹é‡è“çº¿çš„çœŸå®é•¿åº¦](./images/1685457778070.png)

æ£‹ç›˜æ ¼çš„æ¯ä¸€ä¸ªæ–¹å—çš„é•¿åº¦æ˜¯25mmï¼Œ9ä¸ªä¸€å…±225mmï¼Œæœ€ç»ˆçš„æµ‹é‡ç»“æœå¦‚ä¸‹ï¼š

![ä¸‰è§’æµ‹é‡ç»“æœ](./images/1685457828659.png)

æµ‹é‡ç»“æœä¸º225.16mmï¼Œå·²ç»å¾ˆæ¥è¿‘çœŸå®è·ç¦»äº†ã€‚


## åäºŒã€æ€»ç»“

å¯ä»¥çœ‹åˆ°å¯è§†åŒ–çš„ç»“æœä¸­æœ‰æ¯”è¾ƒä¸¥é‡çš„æŠ–åŠ¨ï¼Œç›®å‰è¿˜æ²¡æœ‰ç”¨ä»»ä½•æ»¤æ³¢ã€‚ä¹Ÿæ²¡æœ‰ç”¨ä»»ä½•ä¼˜åŒ–æ–¹æ³•æé«˜å¸§ç‡ï¼Œå¦‚æœä¸å¼€å¯è§†åŒ–çš„è¯åŸºæœ¬ä¸Šæœ‰20å¸§ï¼Œå¼€äº†çš„è¯å°±å¡åœ¨5å¸§ä»¥å†…äº†ï¼Œä½†æ˜¯è¿™äº›éƒ½æ˜¯åè¯äº†ï¼ŒåŸºæœ¬ä»»åŠ¡å·²ç»å®Œæˆã€‚

ğŸ’«ğŸ’«
